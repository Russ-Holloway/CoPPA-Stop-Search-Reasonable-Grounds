# Azure DevOps Pipeline for CoPA Stop & Search
# Secure deployment with Infrastructure as Code using Bicep templates

trigger:
  branches:
    include:
    - main
    - Dev-Ops-Deployment
  paths:
    exclude:
    - '**/*.md'
    - 'docs/**'
    - '**/README*'
    - '.gitignore'
    - '.vscode/**'
    - '.devcontainer/**'
  batch: true  # Batch builds - if multiple commits pushed quickly, only build the latest

pr: none  # Disable automatic PR builds - manual trigger only for PRs

# Variables to control which stages run - set these in your commit message
variables:
  # Global variables
  - name: azureServiceConnectionDev
    value: 'BTP-Development'
  - name: azureServiceConnectionProd
    value: 'BTP-Production'
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: bicepTemplatePath
    value: 'infra/main.bicep'
  - name: bicepParametersPath
    value: 'infra/main.parameters.json'
  
  # Build variables
  - name: buildConfiguration
    value: 'Release'
  - name: pythonVersion
    value: '3.11'
  - name: nodeVersion
    value: '18'
  
  # Skip stages based on commit message - saves time when fixing specific issues
  - name: skipValidation
    value: $[contains(variables['Build.SourceVersionMessage'], '[skip-validation]')]
  - name: skipBuild  
    value: $[contains(variables['Build.SourceVersionMessage'], '[skip-build]')]
  - name: infrastructureOnly
    value: $[contains(variables['Build.SourceVersionMessage'], '[infra-only]')]

variables:
  # Global variables
  - name: azureServiceConnectionDev
    value: 'BTP-Development'
  - name: azureServiceConnectionProd
    value: 'BTP-Production'
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: bicepTemplatePath
    value: 'infra/main.bicep'
  - name: bicepParametersPath
    value: 'infra/main.parameters.json'
  
  # Build variables
  - name: buildConfiguration
    value: 'Release'
  - name: pythonVersion
    value: '3.11'
  - name: nodeVersion
    value: '18'

stages:
- stage: FastInfraValidation
  displayName: 'Fast Infrastructure Validation'
  condition: variables.infrastructureOnly
  jobs:
  - job: ValidateInfrastructureOnly
    displayName: 'Quick Bicep Validation'
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self
      fetchDepth: 1  # Faster checkout
      
    - task: AzureCLI@2
      displayName: 'Quick Bicep Lint Check'
      inputs:
        azureSubscription: $(azureServiceConnectionDev)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Quick validation - installing Bicep..."
          az bicep install
          
          echo "Linting Bicep template..."
          az bicep lint --file $(bicepTemplatePath)
          
          echo "Building Bicep template..."
          az bicep build --file $(bicepTemplatePath)
          
          echo "Quick validation completed - proceeding to deployment"

- stage: Validate
  displayName: 'Validate Infrastructure and Code'
  condition: and(succeeded(), not(variables.skipValidation), not(variables.infrastructureOnly))
  jobs:
  - job: ValidateInfrastructure
    displayName: 'Validate Bicep Templates'
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self
      fetchDepth: 0
      
    - task: AzureCLI@2
      displayName: 'Install Bicep CLI'
      inputs:
        azureSubscription: $(azureServiceConnectionDev)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az bicep install
          az bicep version
    
    - task: AzureCLI@2
      displayName: 'Validate Bicep Template'
      inputs:
        azureSubscription: $(azureServiceConnectionDev)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Validating Bicep template..."
          az bicep build --file $(bicepTemplatePath)
          
          echo "Linting Bicep template..."
          az bicep lint --file $(bicepTemplatePath)
    
    - task: AzureCLI@2
      displayName: 'Security Scan - What-If Analysis'
      inputs:
        azureSubscription: $(azureServiceConnectionDev)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Running what-if analysis at subscription level..."
          # Use subscription-level deployment for what-if analysis
          az deployment sub what-if \
            --location uksouth \
            --template-file $(bicepTemplatePath) \
            --parameters infra/main.devops.parameters.json \
            --verbose
          
          echo "What-if analysis completed successfully"
        
  - job: ValidateApplication
    displayName: 'Validate Application Code'
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self
      fetchDepth: 0
      
    - task: UsePythonVersion@0
      displayName: 'Set up Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        
    - task: NodeTool@0
      displayName: 'Set up Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'
        
    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install flake8 black pylint safety bandit
      displayName: 'Install Python dependencies'
      
    - script: |
        cd frontend
        npm ci
      displayName: 'Install Node.js dependencies'
      
    - script: |
        echo "Running Python security scan with bandit..."
        bandit -r . -f json -o bandit-report.json --exclude ./frontend,./node_modules,./.venv || true
        
        echo "Running Python dependency security check..."
        safety check --json --output safety-report.json || true
        
        echo "Running Python linting for critical errors only..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=frontend,node_modules,.venv
        
        echo "Running Python code formatting check (warnings only)..."
        black --check --diff . --exclude="/(frontend|node_modules|\.venv)/" || echo "Code formatting warnings detected but not failing build"
      displayName: 'Security and Quality Checks'
      
    - script: |
        cd frontend
        echo "Installing frontend dependencies..."
        npm ci
        
        echo "Running TypeScript type checking..."
        npm run typecheck
        
        echo "Building frontend application..."
        npm run build
        
        echo "Verifying build output..."
        if [ -f "../static/index.html" ] && [ -d "../static/assets" ]; then
          echo "Build successful - static directory and assets created"
          echo "Contents of ../static/:"
          ls -la ../static/
          echo "Contents of ../static/assets/:"
          ls -la ../static/assets/
        else
          echo "Build failed - no static directory or assets found"
          echo "Expected: ../static/index.html and ../static/assets/"
          echo "Checking what exists:"
          if [ -d "../static" ]; then
            echo "Static directory contents:"
            ls -la ../static/
          else
            echo "../static directory does not exist"
          fi
          exit 1
        fi
      displayName: 'Frontend Build and Lint'
      
    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFiles: '**/test-results.xml'
        mergeTestResults: true
      displayName: 'Publish Test Results'
      
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Security Reports'
      condition: always()
      inputs:
        pathToPublish: '.'
        artifactName: 'security-reports'
        includes: |
          bandit-report.json
          safety-report.json

- stage: BuildAndPackage
  displayName: 'Build and Package Application'
  dependsOn: []
  condition: and(succeeded(), not(variables.skipBuild), not(variables.infrastructureOnly))
  jobs:
  - job: BuildApplication
    displayName: 'Build Application'
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self
      fetchDepth: 0
      
    - task: UsePythonVersion@0
      displayName: 'Set up Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        
    - task: NodeTool@0
      displayName: 'Set up Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'
        
    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Python dependencies'
      
    - script: |
        cd frontend
        echo "Installing frontend dependencies..."
        npm ci
        
        echo "Building frontend application..."
        npm run build
        
        echo "Verifying build output..."
        if [ -f "../static/index.html" ] && [ -d "../static/assets" ]; then
          echo "Frontend build successful"
          echo "Contents of ../static/:"
          ls -la ../static/
          echo "Contents of ../static/assets/:"
          ls -la ../static/assets/
        else
          echo "Frontend build failed - no static directory or assets found"
          echo "Expected: ../static/index.html and ../static/assets/"
          echo "Checking what exists:"
          if [ -d "../static" ]; then
            echo "Static directory contents:"
            ls -la ../static/
          else
            echo "../static directory does not exist"
          fi
          exit 1
        fi
      displayName: 'Build Frontend'
      
    - script: |
        echo "Preparing deployment package..."
        mkdir -p $(Build.ArtifactStagingDirectory)/app
        
        # Copy application files
        cp -r *.py $(Build.ArtifactStagingDirectory)/app/ || true
        cp -r backend/ $(Build.ArtifactStagingDirectory)/app/ || true
        cp -r static/ $(Build.ArtifactStagingDirectory)/app/ || true
        cp requirements.txt $(Build.ArtifactStagingDirectory)/app/
        cp start.sh $(Build.ArtifactStagingDirectory)/app/
        cp gunicorn.conf.py $(Build.ArtifactStagingDirectory)/app/ || true
        cp WebApp.Dockerfile $(Build.ArtifactStagingDirectory)/app/ || true
        
        # Static directory (including built frontend) is already copied above
        echo "Frontend build files included in static/ directory"
        
        echo "Application package prepared"
        ls -la $(Build.ArtifactStagingDirectory)/app/
      displayName: 'Package Application'
      
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Application Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/app'
        artifactName: 'copa-application'
        
  - job: PackageInfrastructure
    displayName: 'Package Infrastructure'
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self
      fetchDepth: 0
      
    - script: |
        echo "Preparing infrastructure package..."
        mkdir -p $(Build.ArtifactStagingDirectory)/infra
        
        # Copy Bicep templates
        cp -r infra/ $(Build.ArtifactStagingDirectory)/
        
        # Copy createUIDefinition for portal deployments (backup option)
        cp infrastructure/createUiDefinition.json $(Build.ArtifactStagingDirectory)/infra/ || true
        
        echo "Infrastructure package prepared"
        ls -la $(Build.ArtifactStagingDirectory)/infra/
      displayName: 'Package Infrastructure'
      
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Infrastructure Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/infra'
        artifactName: 'copa-infrastructure'

- stage: DeployDevelopment
  displayName: 'Deploy to Development'
  dependsOn: []
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/Dev-Ops-Deployment'))
  variables:
  - group: 'copa-stop-search-dev-variables'
  - name: environmentName
    value: 'development'
  - name: resourceGroupName
    value: 'rg-btp-d-copa-stop-search'
  - name: azureLocation
    value: 'uksouth'
  jobs:
  - deployment: DeployInfrastructure
    displayName: 'Deploy Infrastructure to Development'
    environment: 'BTP-Development'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            fetchDepth: 1
            condition: variables.infrastructureOnly
            
          - download: current
            artifact: 'copa-infrastructure'
            condition: not(variables.infrastructureOnly)
            
          - download: current
            artifact: 'copa-application'
            condition: not(variables.infrastructureOnly)
            
          - task: AzureCLI@2
            displayName: 'Create Resource Group'
            inputs:
              azureSubscription: $(azureServiceConnectionDev)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Creating resource group with required BTP policy tags..."
                az group create \
                  --name $(resourceGroupName) \
                  --location $(azureLocation) \
                  --tags \
                    Owner="DevOps-Pipeline" \
                    CostCentre="IT-001" \
                    ForceID="BTP" \
                    ServiceName="CoPA-Stop-Search" \
                    LocationID="UK-South" \
                    Environment="Development"
                echo "Resource group created successfully with all required tags"
                
          - task: AzureCLI@2
            displayName: 'Deploy Infrastructure'
            inputs:
              azureSubscription: $(azureServiceConnectionDev)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying Bicep template with DevOps parameters..."
                
                # Determine template path based on deployment type
                if [ "$(variables.infrastructureOnly)" = "True" ]; then
                  TEMPLATE_PATH="infra/main.bicep"
                  PARAMS_PATH="infra/main.devops.parameters.json"
                else
                  TEMPLATE_PATH="$(Pipeline.Workspace)/copa-infrastructure/main.bicep"
                  PARAMS_PATH="$(Pipeline.Workspace)/copa-infrastructure/main.devops.parameters.json"
                fi
                
                # Base deployment with parameters file
                DEPLOYMENT_CMD="az deployment group create \
                  --resource-group $(resourceGroupName) \
                  --name $(Build.BuildNumber)-infrastructure \
                  --template-file $TEMPLATE_PATH \
                  --parameters $PARAMS_PATH \
                  --verbose"
                
                # Add OpenAI model parameters if variables are set
                if [ -n "$(openAIModel)" ] && [ "$(openAIModel)" != "\$(openAIModel)" ]; then
                  DEPLOYMENT_CMD="$DEPLOYMENT_CMD --parameters azureOpenAIModelName=$(openAIModel)"
                fi
                
                if [ -n "$(embeddingModel)" ] && [ "$(embeddingModel)" != "\$(embeddingModel)" ]; then
                  DEPLOYMENT_CMD="$DEPLOYMENT_CMD --parameters azureOpenAIEmbeddingName=$(embeddingModel)"
                fi
                
                echo "Executing deployment command..."
                eval $DEPLOYMENT_CMD
                echo "Infrastructure deployment completed successfully"
                
                # Set web app name based on BTP naming convention from Bicep template
                WEB_APP_NAME="app-btp-d-copa-stop-search-001"
                echo "Setting web app name to: $WEB_APP_NAME"
                echo "##vso[task.setvariable variable=webAppName]$WEB_APP_NAME"
                
          - task: AzureCLI@2
            displayName: 'Verify Web App Exists'
            condition: not(variables.infrastructureOnly)
            inputs:
              azureSubscription: $(azureServiceConnectionDev)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking if web app exists: $(webAppName)"
                
                if az webapp show --name "$(webAppName)" --resource-group "$(resourceGroupName)" >/dev/null 2>&1; then
                  echo "✅ Web app $(webAppName) exists and is ready for deployment"
                else
                  echo "❌ Web app $(webAppName) does not exist!"
                  echo "Available web apps in resource group $(resourceGroupName):"
                  az webapp list --resource-group "$(resourceGroupName)" --query "[].name" --output table || echo "No web apps found"
                  exit 1
                fi
                    
          - task: AzureWebApp@1
            displayName: 'Deploy Application'
            condition: not(variables.infrastructureOnly)
            inputs:
              azureSubscription: $(azureServiceConnectionDev)
              appType: 'webAppLinux'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/copa-application'
              runtimeStack: 'PYTHON|3.11'
              
          - task: AzureCLI@2
            displayName: 'Verify Application Deployment'
            condition: not(variables.infrastructureOnly)
            inputs:
              azureSubscription: $(azureServiceConnectionDev)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Verifying web app deployment..."
                WEB_APP_URL="https://$(webAppName).azurewebsites.net"
                echo "Web app URL: $WEB_APP_URL"
                
                # Wait a moment for the app to start
                sleep 30
                
                # Check if the app is responding
                HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$WEB_APP_URL" || echo "000")
                echo "HTTP Status: $HTTP_STATUS"
                
                if [[ "$HTTP_STATUS" == "200" ]] || [[ "$HTTP_STATUS" == "302" ]]; then
                  echo "✅ Web app is responding successfully"
                else
                  echo "⚠️ Web app returned status $HTTP_STATUS, but deployment completed"
                  echo "This might be normal if the app takes time to start"
                fi

- stage: DeployProduction
  displayName: 'Deploy to Production'
  dependsOn: BuildAndPackage
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
  - group: 'copa-stop-search-prod-variables'
  - name: environmentName
    value: 'production'
  jobs:
  - deployment: DeployInfrastructure
    displayName: 'Deploy Infrastructure to Production'
    environment: 'BTP-Production'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none
            
          - download: current
            artifact: 'copa-infrastructure'
            
          - download: current
            artifact: 'copa-application'
            
          - task: AzureCLI@2
            displayName: 'Create Resource Group'
            inputs:
              azureSubscription: $(azureServiceConnectionProd)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Creating production resource group with required BTP policy tags..."
                az group create \
                  --name $(resourceGroupName) \
                  --location $(azureLocation) \
                  --tags \
                    Owner="Production-Team" \
                    CostCentre="IT-001" \
                    ForceID="BTP" \
                    ServiceName="CoPA-Stop-Search" \
                    LocationID="UK-South" \
                    Environment="Production"
                echo "Production resource group created successfully with all required tags"
            
          - task: AzureCLI@2
            displayName: 'Deploy Infrastructure'
            inputs:
              azureSubscription: $(azureServiceConnectionProd)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying Bicep template with Production parameters..."
                
                # Base deployment with parameters file
                DEPLOYMENT_CMD="az deployment group create \
                  --resource-group $(resourceGroupName) \
                  --template-file $(Pipeline.Workspace)/copa-infrastructure/main.bicep \
                  --parameters $(Pipeline.Workspace)/copa-infrastructure/main.production.parameters.json \
                  --verbose"
                
                # Add OpenAI model parameters if variables are set
                if [ -n "$(openAIModel)" ] && [ "$(openAIModel)" != "\$(openAIModel)" ]; then
                  DEPLOYMENT_CMD="$DEPLOYMENT_CMD --parameters azureOpenAIModelName=$(openAIModel)"
                fi
                
                if [ -n "$(embeddingModel)" ] && [ "$(embeddingModel)" != "\$(embeddingModel)" ]; then
                  DEPLOYMENT_CMD="$DEPLOYMENT_CMD --parameters azureOpenAIEmbeddingName=$(embeddingModel)"
                fi
                
                echo "Executing deployment command..."
                eval $DEPLOYMENT_CMD
                echo "Production infrastructure deployment completed successfully"
                
                # Set web app name based on BTP naming convention for production
                WEB_APP_NAME="app-btp-p-copa-stop-search-001"
                echo "Setting production web app name to: $WEB_APP_NAME"
                echo "##vso[task.setvariable variable=webAppName]$WEB_APP_NAME"
                
          - task: AzureCLI@2
            displayName: 'Verify Web App Exists'
            inputs:
              azureSubscription: $(azureServiceConnectionProd)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking if production web app exists: $(webAppName)"
                
                if az webapp show --name "$(webAppName)" --resource-group "$(resourceGroupName)" >/dev/null 2>&1; then
                  echo "✅ Production web app $(webAppName) exists and is ready for deployment"
                else
                  echo "❌ Production web app $(webAppName) does not exist!"
                  echo "Available web apps in resource group $(resourceGroupName):"
                  az webapp list --resource-group "$(resourceGroupName)" --query "[].name" --output table || echo "No web apps found"
                  exit 1
                fi
                    
          - task: AzureWebApp@1
            displayName: 'Deploy Application'
            inputs:
              azureSubscription: $(azureServiceConnectionProd)
              appType: 'webAppLinux'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/copa-application'
              runtimeStack: 'PYTHON|3.11'
              
          - task: AzureCLI@2
            displayName: 'Verify Production Application Deployment'
            inputs:
              azureSubscription: $(azureServiceConnectionProd)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Verifying production web app deployment..."
                WEB_APP_URL="https://$(webAppName).azurewebsites.net"
                echo "Production web app URL: $WEB_APP_URL"
                
                # Wait a moment for the app to start
                sleep 30
                
                # Check if the app is responding
                HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$WEB_APP_URL" || echo "000")
                echo "HTTP Status: $HTTP_STATUS"
                
                if [[ "$HTTP_STATUS" == "200" ]] || [[ "$HTTP_STATUS" == "302" ]]; then
                  echo "✅ Production web app is responding successfully"
                else
                  echo "⚠️ Production web app returned status $HTTP_STATUS, but deployment completed"
                  echo "This might be normal if the app takes time to start"
                fi