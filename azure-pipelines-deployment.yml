trigger:
  branches:
    include:
    - main
  paths:
    include:
    - deployment.json

pool:
  vmImage: 'windows-latest'

variables:
  # Update these variables with your actual values
  resourceGroupName: 'rg-policing-assistant-public'
  storageAccountName: 'sapolassistdeployment'
  containerName: 'templates'
  deploymentJsonPath: '$(Build.Repository.LocalPath)/deployment.json'

steps:
- task: AzureCLI@2
  displayName: 'Copy deployment.json to Azure Blob Storage'
  inputs:
    azureSubscription: 'Your-Azure-Service-Connection' # Replace with your Azure service connection name
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Upload the deployment.json file to the storage container
      az storage blob upload `
        --account-name $(storageAccountName) `
        --container-name $(containerName) `
        --name "deployment.json" `
        --file "$(deploymentJsonPath)" `
        --auth-mode login `
        --overwrite true
      
      # Generate a SAS token that will be valid for 1 year
      $expiryDate = (Get-Date).AddYears(1).ToString("yyyy-MM-ddTHH:mm:ssZ")
      $sasToken = az storage blob generate-sas `
        --account-name $(storageAccountName) `
        --container-name $(containerName) `
        --name "deployment.json" `
        --permissions r `
        --expiry $expiryDate `
        --auth-mode login `
        --as-user `
        --output tsv
      
      # Output the full URL with SAS token
      $fullUrl = "https://$(storageAccountName).blob.core.windows.net/$(containerName)/deployment.json?$sasToken"
      Write-Host "##vso[task.setvariable variable=BlobUrl;isOutput=true]$fullUrl"
      Write-Host "Deployment JSON uploaded successfully to: $fullUrl"
      
      # Save the URL to a file that can be downloaded as an artifact
      $fullUrl | Out-File -FilePath "$(Build.ArtifactStagingDirectory)/deployment_url.txt"

- task: PublishBuildArtifacts@1
  displayName: 'Publish URL Artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'DeploymentURL'
    publishLocation: 'Container'
