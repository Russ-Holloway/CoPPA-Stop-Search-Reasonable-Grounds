{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "7690697640273114578"
    }
  },
  "parameters": {
    "name": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "tags": {
      "type": "object",
      "defaultValue": {}
    },
    "accessTier": {
      "type": "string",
      "defaultValue": "Hot",
      "allowedValues": [
        "Hot",
        "Cool",
        "Premium"
      ]
    },
    "allowBlobPublicAccess": {
      "type": "bool",
      "defaultValue": false
    },
    "allowCrossTenantReplication": {
      "type": "bool",
      "defaultValue": false
    },
    "allowSharedKeyAccess": {
      "type": "bool",
      "defaultValue": false
    },
    "defaultToOAuthAuthentication": {
      "type": "bool",
      "defaultValue": true
    },
    "deleteRetentionPolicy": {
      "type": "object",
      "defaultValue": {}
    },
    "dnsEndpointType": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "AzureDnsZone",
        "Standard"
      ]
    },
    "kind": {
      "type": "string",
      "defaultValue": "StorageV2"
    },
    "minimumTlsVersion": {
      "type": "string",
      "defaultValue": "TLS1_2"
    },
    "publicNetworkAccess": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ]
    },
    "sku": {
      "type": "object",
      "defaultValue": {
        "name": "Standard_LRS"
      }
    },
    "ipRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Array of IP addresses or ranges to allow access from"
      }
    },
    "virtualNetworkRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Array of virtual network resource IDs to allow access from"
      }
    },
    "containers": {
      "type": "array",
      "defaultValue": []
    }
  },
  "resources": [
    {
      "copy": {
        "name": "storage::blobServices::container",
        "count": "[length(parameters('containers'))]"
      },
      "condition": "[not(empty(parameters('containers')))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-05-01",
      "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('containers')[copyIndex()].name)]",
      "properties": {
        "publicAccess": "[coalesce(tryGet(parameters('containers')[copyIndex()], 'publicAccess'), 'None')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('containers')))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2022-05-01",
      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
      "properties": {
        "deleteRetentionPolicy": "[parameters('deleteRetentionPolicy')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-05-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "kind": "[parameters('kind')]",
      "sku": "[parameters('sku')]",
      "properties": {
        "accessTier": "[parameters('accessTier')]",
        "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
        "allowCrossTenantReplication": "[parameters('allowCrossTenantReplication')]",
        "allowSharedKeyAccess": "[parameters('allowSharedKeyAccess')]",
        "defaultToOAuthAuthentication": "[parameters('defaultToOAuthAuthentication')]",
        "dnsEndpointType": "[parameters('dnsEndpointType')]",
        "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
        "networkAcls": {
          "copy": [
            {
              "name": "ipRules",
              "count": "[length(parameters('ipRules'))]",
              "input": {
                "action": "Allow",
                "value": "[parameters('ipRules')[copyIndex('ipRules')]]"
              }
            },
            {
              "name": "virtualNetworkRules",
              "count": "[length(parameters('virtualNetworkRules'))]",
              "input": {
                "action": "Allow",
                "id": "[parameters('virtualNetworkRules')[copyIndex('virtualNetworkRules')]]"
              }
            }
          ],
          "bypass": "AzureServices",
          "defaultAction": "[if(equals(parameters('publicNetworkAccess'), 'Enabled'), 'Allow', 'Deny')]"
        },
        "publicNetworkAccess": "[parameters('publicNetworkAccess')]"
      }
    }
  ],
  "outputs": {
    "name": {
      "type": "string",
      "value": "[parameters('name')]"
    },
    "primaryEndpoints": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2022-05-01').primaryEndpoints]"
    },
    "id": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
    }
  }
}